#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

if [[ -z "${TRAEFIK_HOST}" ]]; then
    exit 3 # Module is not fully configured, abort execution.
fi

mkdir -vp ${AGENT_STATE_DIR}/certificates/

tmpdir=$(mktemp -d)
trap 'rm -rf ${tmpdir}' EXIT

cd "${tmpdir}"
umask 022 # 644

# Override redis-exec "privileged=True"
export REDIS_USER=default

mtraefik=$(redis-exec GET "node/${NODE_ID}/default_instance/traefik")

redis-exec HGET "module/${mtraefik}/certificate/${TRAEFIK_HOST}" key | base64 -d > server.key
redis-exec HGET "module/${mtraefik}/certificate/${TRAEFIK_HOST}" cert | base64 -d > server.pem

if [[ $(head -c 5 server.key) != '-----' || $(head -c 5 server.pem) != '-----' ]]; then
    echo "[WARNING] ${service_image} certificate for ${TRAEFIK_HOST} not found" 1>&2
    exit 2
fi

# we want only one pem file all included
cat server.key server.pem > ${AGENT_STATE_DIR}/certificates/goauthentik.pem

# Inlcluding Seprate Files
cp server.key ${AGENT_STATE_DIR}/certificates/key.pem
cp server.pem ${AGENT_STATE_DIR}/certificates/cert.pem
# Important! preserve import-certificate exit code

# Copy server.key and server.pem into the goauthentik-app pod's certs folder
podman cp ${AGENT_STATE_DIR}/certificates/key.pem goauthentik-app:/certs/key.pem || true
podman cp ${AGENT_STATE_DIR}/certificates/cert.pem goauthentik-app:/certs/cert.pem || true

# Check for both files in the container; log warning if either missing, exit if both missing
if ! podman exec goauthentik-app sh -c '[ -f /certs/key.pem ] && [ -f /certs/cert.pem ]'; then
  if ! podman exec goauthentik-app sh -c '[ -f /certs/key.pem ] || [ -f /certs/cert.pem ]'; then
      logger -p user.err "Error: Both certificate files missing in container."
      exit 1
  else
      logger -p user.err "Warning: One certificate file missing in container."
  fi
fi

# Proceed with the import command
/usr/bin/podman exec goauthentik-app ak import_certificate \
  --certificate /certs/cert.pem \
  --private-key /certs/key.pem \
  --name goauthentik \
  || { logger -p user.err "Failed to import certificate: $?" ; exit 1 }